#!/usr/bin/env bash
set -e

#
# Helpers
##################################################

export PATH="$PATH:node_modules/.bin"
export ROOT="$PWD"

source src/bash-partials/colors.sh
source src/bash-partials/env.sh

run() {
  echo "$@"
  "$@"
}

#
# Commands
##################################################

lint() {
  run tslint \
    --project tsconfig.json \
    --config tslint.json \
    --format stylish \
    --fix
}

clean() {
  run rm -rf dist
}

build() {
  run rm -rf dist/*.sh
  run rm -rf dist/node
  run rm -rf generated

  run mkdir -p dist/node
  run mkdir -p generated/bash
  run mkdir -p generated/bash-partials
  run mkdir -p generated/node

  run tsc -p tsconfig.json
  run node generated/bash/generate.js

  run cp -R generated/node/* dist/node/
  run cp generated/bash/index.sh dist/bash.sh

  # preserve existing package.json
  if [ ! -f dist/package.json ]; then
    run cp src/package.json dist/package.json
  fi

  run cd "$ROOT/dist"
  run source bash.sh

  run cd "$ROOT/src/install"
  run ./index.sh
}

dot_yarn() {
  if [ -z "$DOT_PATH" ]; then
    echo This should only be called from within sourced dotfiles.
    return
  fi

  export PATH="$SYSTEM_PATH"
  cd "$DOT_ROOT"
  which yarn
  (
    run yarn "$@"
  )
  export PATH="$DOT_PATH"
}

update() {
  build
  dot_yarn upgrade
}

install() {
  clean
  update
}

#
# CLI
##################################################

#
# Call the function specified by the first parameter, passing all remaining
# parameters to the function. If no such function exists, display usage info.
#
if [ -n "$1" ] && type $1 | grep -i function > /dev/null; then
  yarn
  command="$1"
  shift
  $command ${@}
else
  fail "No such command: $1"
fi
